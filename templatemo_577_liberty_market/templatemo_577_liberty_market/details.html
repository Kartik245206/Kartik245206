<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="templatemo" name="author"/>
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&amp;display=swap" rel="stylesheet"/>
<title>Liberty Market - Item Details</title>
<!-- Bootstrap core CSS -->
<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
<!-- Additional CSS Files -->
<link href="assets/css/fontawesome.css" rel="stylesheet"/>
<link href="assets/css/templatemo-liberty-market.css" rel="stylesheet"/>
<link href="assets/css/owl.css" rel="stylesheet"/>
<link href="assets/css/animate.css" rel="stylesheet"/>
<link href="https://unpkg.com/swiper@7/swiper-bundle.min.css" rel="stylesheet">



<style>
/* Add these styles for better UI/UX */
.item-details-page .left-image img {
    transition: transform 0.3s ease;
}

.item-details-page .left-image img:hover {
    transform: scale(1.02);
}

.main-button, .border-button {
    transition: all 0.3s ease;
}

.main-button:hover, .border-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.side-nav-item {
    transition: all 0.3s ease;
}

.side-nav-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateX(5px);
}

.menu-trigger span {
    transition: all 0.3s ease;
}

.menu-trigger.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.menu-trigger.active span:nth-child(2) {
    opacity: 0;
}

.menu-trigger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
}
</style>
</head>



<body>
<!-- Common JavaScript Functions -->
<script src="assets/js/common.js"></script>
<script>
// Test if common.js is loaded
console.log('Common.js loaded, updateUserBalance function:', typeof updateUserBalance);
console.log('Common.js loaded, getCategoryClass function:', typeof getCategoryClass);
</script>

<div class="user-account-info" id="userAccountInfo">
    <div class="user-profile-pic">
        <img src="assets/images/author.jpg" alt="Profile" id="userProfilePic">
    </div>
    <div class="user-balance-info">
        <div class="balance-amount" id="userBalanceAmount">₹0</div>
        <div class="balance-label">Available Balance</div>
    </div>
</div>

<script>
window.addEventListener('load', function() {
    const header = document.querySelector('.header-area .main-nav');
    if (header) {
        // Add menu trigger if it doesn't exist
        let menuTrigger = header.querySelector('.menu-trigger');
        
        if (!menuTrigger) {
            menuTrigger = document.createElement('a');
            menuTrigger.className = 'menu-trigger';
            menuTrigger.href = '#';
            
            // Create hamburger icon
            const span1 = document.createElement('span');
            const span2 = document.createElement('span');
            const span3 = document.createElement('span');
            
            menuTrigger.appendChild(span1);
            menuTrigger.appendChild(span2);
            menuTrigger.appendChild(span3);
            
            // Add menu trigger to header
            header.appendChild(menuTrigger);
        }
        
        // Add click event to menu trigger
        menuTrigger.addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.toggle('active');
            const nav = header.querySelector('.nav');
            if (nav) {
                nav.classList.toggle('active');
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav') && !e.target.closest('.menu-trigger')) {
                menuTrigger.classList.remove('active');
                const nav = header.querySelector('.nav');
                if (nav) {
                    nav.classList.remove('active');
                }
            }
        });
    }
});
</script>


<!-- ***** Preloader Start ***** -->
<div class="js-preloader" id="js-preloader">
<div class="preloader-inner">
<span class="dot"></span>
<div class="dots">
<span></span>
<span></span>
<span></span>
</div>
</div>
</div>
<!-- ***** Preloader End ***** -->
<!-- ***** Header Area Start ***** -->
<header class="header-area header-sticky">
    <div class="menu-trigger" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <nav class="main-nav">
                      <!-- ***** Logo Start ***** -->
                      <div class="text-center logo-container">
                          <a href="index.html" class="logo">
                              <img src="assets/images/logo.png" alt="">
                          </a>
                      </div>
                      <!-- ***** Logo End ***** -->
                      
                      <!-- ***** Menu Start ***** -->
                      <ul class="nav">
                          <li><a href="index.html">Home</a></li>
                          <li><a href="profile.html">Profile</a></li>
                          <li><a href="Host-WEB/admin_Login_page.html">Admin</a></li>
                          <li><a href="signup.html">Logout</a></li>
                      </ul>
                      <!-- ***** Menu End ***** -->
                  </nav>
              </div>
          </div>
      </div>
  </header>
  <!-- ***** Header Area End ***** -->
<div class="side-nav">
    <div class="side-nav-item" onclick="window.location.href='index.html'">
        <div class="side-nav-icon">
            <i class="fa fa-home"></i>
        </div>
        <div class="side-nav-text">Home</div>
    </div>
    <div class="side-nav-item" onclick="window.location.href='profile.html'">
        <div class="side-nav-icon">
            <i class="fa fa-user"></i>
        </div>
        <div class="side-nav-text">Profile</div>
    </div>
    <div class="side-nav-item" onclick="window.location.href='Host-WEB/admin_Login_page.html'">
        <div class="side-nav-icon">
            <i class="fa fa-cog"></i>
        </div>
        <div class="side-nav-text">Admin</div>
    </div>
</div>
<!-- ***** Main Banner Area Start ***** -->
<div class="main-banner">
  <div class="container">
    <div class="row">
      <div class="col-lg-4 align-self-center">
        <div class="header-text">
          <h1>Product Details</h1>
          <p><h4>View complete information about this product</h4></p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ***** Main Banner Area End ***** -->
<!-- ***** Currently Market Area Start ***** -->
<div class="currently-market">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-heading">
                    <div class="line-dec"></div>
                    <h2><em>Product</em> Details</h2>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="row currently-market-items">
                    <div class="col-lg-12 currently-market-item">
                        <div class="item">
                            <div class="left-image">
                                <img id="product-image" alt="Product Image" style="border-radius: 20px; max-width: 100%; height: auto; object-fit: cover;"/>
                            </div>
                            <div class="right-content">
                                <h4 id="product-name"></h4>
                                <span class="author"><h2 id="plans-text"></h2></span>
                                <div class="line-dec"></div>
                                <span class="bid">Amount/Day<br><strong id="product-price"></strong>/day</span>
                                <span class="ends">Total Amount<br><strong id="product-total"></strong></span>
                                <span class="category">Category<br><strong id="product-category"></strong></span>
                                <span class="duration">Duration<br><strong id="due-date"></strong> Days</span>
                                <div class="earn-info">
                                    <h3 id="earn-text"></h3>
                                </div>
                                <form id="paymentForm" class="mt-3">
                                    <div class="form-group">
                                        <label for="amount">Enter Amount (₹):</label>
                                        <input 
                                            class="form-control" 
                                            id="amount" 
                                            min="1" 
                                            placeholder="Enter exact amount" 
                                            required 
                                            step="1" 
                                            type="number" />
                                    </div>
                                    <button class="main-button" id="form-submit" type="submit">Apply</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ***** Currently Market Area End ***** -->

<style>
/* Product Details Page Styling */
.currently-market-item .item {
    background: rgba(40, 43, 47, 0.95);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 40px;
}

.currently-market-item .item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    border-color: rgba(116, 83, 252, 0.5);
}

.currently-market-item .item .left-image {
    flex: 0 0 400px;
    overflow: hidden;
    border-radius: 20px;
}

.currently-market-item .item .left-image img {
    width: 100%;
    height: auto;
    border-radius: 20px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.currently-market-item .item .left-image img:hover {
    transform: scale(1.05);
}

.currently-market-item .item .right-content {
    flex: 1;
    padding: 0;
}

.currently-market-item .item .right-content h4 {
    color: #fff;
    margin-bottom: 15px;
    font-size: 24px;
}

.currently-market-item .item .right-content .author h2 {
    color: #7453fc;
    font-size: 20px;
    margin-bottom: 20px;
}

.currently-market-item .item .right-content .line-dec {
    width: 60px;
    height: 3px;
    background: #7453fc;
    margin: 0 0 20px 0;
    border-radius: 2px;
}

.currently-market-item .item .right-content .bid,
.currently-market-item .item .right-content .ends,
.currently-market-item .item .right-content .category,
.currently-market-item .item .right-content .duration {
    display: block;
    margin-bottom: 15px;
    color: #b4b2ba;
    font-size: 14px;
}

.currently-market-item .item .right-content .bid strong,
.currently-market-item .item .right-content .ends strong,
.currently-market-item .item .right-content .category strong,
.currently-market-item .item .right-content .duration strong {
    color: #7453fc;
    font-size: 18px;
}

.currently-market-item .item .right-content .earn-info {
    margin: 25px 0;
    padding: 20px;
    background: rgba(116, 83, 252, 0.1);
    border-radius: 15px;
    border: 1px solid rgba(116, 83, 252, 0.3);
}

.currently-market-item .item .right-content .earn-info h3 {
    color: #7453fc;
    font-size: 22px;
    margin: 0;
    text-align: center;
}

.currently-market-item .item .right-content .form-group {
    margin-bottom: 20px;
}

.currently-market-item .item .right-content .form-group label {
    color: #fff;
    margin-bottom: 8px;
    display: block;
}

.currently-market-item .item .right-content .form-control {
    background-color: #37393c;
    border: 1px solid #404245;
    color: #fff;
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    width: 100%;
}

.currently-market-item .item .right-content .form-control:focus {
    background-color: #37393c;
    border-color: #7453fc;
    color: #fff;
    box-shadow: 0 0 0 0.25rem rgba(116, 83, 252, 0.25);
}

.currently-market-item .item .right-content .main-button {
    background: #7453fc;
    color: #fff;
    padding: 12px 30px;
    border-radius: 25px;
    text-decoration: none;
    display: inline-block;
    border: none;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.currently-market-item .item .right-content .main-button:hover {
    background: #5b42c7;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(116, 83, 252, 0.3);
}

/* Mobile responsive styles for product details */
@media (max-width: 768px) {
    .currently-market-item .item {
        flex-direction: column;
        padding: 25px;
        gap: 25px;
        text-align: center;
    }
    
    .currently-market-item .item .left-image {
        flex: none;
        width: 100%;
        max-width: 300px;
    }
    
    .currently-market-item .item .right-content {
        text-align: center;
    }
    
    .currently-market-item .item .right-content .line-dec {
        margin: 0 auto 20px auto;
    }
    
    .currently-market-item .item .right-content .bid,
    .currently-market-item .item .right-content .ends,
    .currently-market-item .item .right-content .category,
    .currently-market-item .item .right-content .duration {
        text-align: center;
    }
}

/* Additional styles for existing elements */
.item-details-page .row > div {
    padding: 15px;
}

/* Main Navigation Styles */
.main-nav {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    position: relative;
    padding: 15px 0;
    max-width: 1200px;
    margin: 0 auto;
}

.logo-container {
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    z-index: 1;
}

.logo img {
    width: 220px;
    height: auto;
    max-width: 100%;
    margin: 0 auto;
}

/* Header Area Styles */
.header-area {
    background: rgba(1, 11, 44, 0.9);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
}

/* Main Banner Styles */
.main-banner {
    background-image: url(assets/images/banner-bg.jpg);
    background-position: center center;
    background-repeat: no-repeat;
    background-size: cover;
    padding: 100px 0px;
    margin-bottom: 60px;
    border-radius: 0px;
    position: relative;
}

.main-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 0px;
}

.main-banner .container {
    position: relative;
    z-index: 1;
}

.main-banner .header-text {
    padding: 0;
    margin: 20px 0;
    text-align: center;
}

.main-banner .header-text h1 {
    font-size: 32px;
    margin-bottom: 15px;
    color: #fff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
}

.main-banner .header-text h4 {
    font-size: 18px;
    color: #b4b2ba;
    line-height: 1.6;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
}

/* Section Heading Styles */
.section-heading {
    margin-bottom: 30px;
    text-align: center;
}

.section-heading h2 {
    font-size: 32px;
    color: #fff;
    margin-bottom: 15px;
}

.section-heading .line-dec {
    width: 60px;
    height: 3px;
    background: #7453fc;
    margin: 0 auto 20px auto;
    border-radius: 2px;
}

/* Currently Market Section Styles */
.currently-market {
    padding: 80px 0;
    background: rgba(40, 43, 47, 0.95);
    border-radius: 20px;
    margin: 20px 0;
}

.currently-market-items {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}

/* Desktop Navigation Styles */
@media (min-width: 992px) {
    .menu-trigger {
        display: none;
    }
    
    .nav {
        display: flex !important;
        position: static;
        background: none;
        padding: 0;
        box-shadow: none;
        width: auto;
    }
    
    .nav li {
        display: inline-block;
        margin: 0 15px;
    }
    
    .nav li a {
        color: #fff;
        text-decoration: none;
        padding: 10px 15px;
        border-radius: 20px;
        transition: all 0.3s ease;
    }
    
    .nav li a:hover {
        background: rgba(116, 83, 252, 0.2);
        color: #7453fc;
    }
    
    .main-nav {
        display: grid;
        justify-content: space-between;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
    }
    
    .logo-container {
        position: relative;
        text-align: center;
        z-index: 1;
        transform: none;
    }
}

.bid, .category, .ends {
    margin-bottom: 20px;
    text-align: center;
}

#paymentForm {
    padding: 15px;
}

.user-account-info {
    margin: 20px auto;
    max-width: 300px;
    display: flex;
    align-items: center;
    background: rgba(116, 83, 252, 0.1);
    padding: 10px 15px;
    border-radius: 15px;
    border: 1px solid rgba(116, 83, 252, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
}

.user-account-info:hover {
    background: rgba(116, 83, 252, 0.2);
    border-color: #7453fc;
    transform: scale(1.05);
}

.user-profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 10px;
    border: 2px solid #b4b2ba;
}

.user-profile-pic img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-balance-info {
    text-align: left;
}

.balance-amount {
    font-weight: bold;
    color: #7453fc;
    font-size: 16px;
}

.balance-label {
    font-size: 12px;
    color: #afafaf;
}

/* Side Navigation Styles */
.side-nav {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(40, 43, 47, 0.95);
    padding: 15px;
    border-radius: 0 15px 15px 0;
    z-index: 1000;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.side-nav-item {
    display: flex;
    align-items: center;
    margin: 20px 0;
    cursor: pointer;
    transition: all 0.3s;
}

.side-nav-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #7453fc;
    border-radius: 50%;
    margin-right: 15px;
}

.side-nav-icon i {
    color: white;
    font-size: 18px;
}

.side-nav-text {
    color: white;
    opacity: 0;
    width: 0;
    overflow: hidden;
    white-space: nowrap;
    transition: all 0.3s;
}

.side-nav:hover .side-nav-text {
    opacity: 1;
    width: 120px;
}

/* Mobile Side Navigation */
@media (max-width: 767px) {
    .side-nav {
        bottom: 0;
        top: auto;
        left: 0;
        right: 0;
        transform: none;
        display: flex;
        justify-content: space-around;
        border-radius: 15px 15px 0 0;
        padding: 8px;
        z-index: 1001;
    }
    
    .side-nav-item {
        margin: 3px;
        flex-direction: column;
    }
    
    .side-nav-icon {
        margin-right: 0;
        margin-bottom: 3px;
        width: 30px;
        height: 20px;
    }
    
    .side-nav-text {
        opacity: 1;
        width: auto;
        font-size: 10px;
    }
}

/* Preloader Styles */
.js-preloader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.98);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    visibility: visible;
    z-index: 9999;
    transition: opacity 0.25s ease;
}

.js-preloader.loaded {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

.preloader-inner {
    text-align: center;
}

.dot {
    width: 20px;
    height: 20px;
    background: #7453fc;
    border-radius: 50%;
    display: inline-block;
    margin: 0 5px;
    animation: pulse 1.5s infinite;
}

.dots span {
    width: 15px;
    height: 15px;
    background: #7453fc;
    border-radius: 50%;
    display: inline-block;
    margin: 0 3px;
    animation: pulse 1.5s infinite;
    animation-delay: 0.2s;
}

.dots span:nth-child(2) {
    animation-delay: 0.4s;
}

.dots span:nth-child(3) {
    animation-delay: 0.6s;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
}

/* Body Background */
body {
    background-color: #1e1e1e;
    background-image: url(assets/images/dark-bg.jpg);
    background-size: cover;
    background-attachment: fixed;
    background-position: center;
    color: #fff;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Mobile Main Banner */
@media (max-width: 576px) {
    .main-banner {
        padding: 60px 0 30px 0;
    }
    
    .main-banner .header-text h1 {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .main-banner .header-text h4 {
        font-size: 16px;
    }
    
    .currently-market {
        padding: 40px 0;
        margin: 10px 0;
    }
    
    .section-heading h2 {
        font-size: 20px;
    }
}

.menu-trigger {
    display: block;
    position: absolute;
    right: 15px;
    top: 15px;
    background: #7453fc;
    border-radius: 5px;
    padding: 10px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    z-index: 1001;
}

.menu-trigger span {
    display: block;
    width: 25px;
    height: 2px;
    background: white;
    margin: 5px 0;
    transition: all 0.3s ease;
}

.menu-trigger.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
}

.menu-trigger.active span:nth-child(2) {
    opacity: 0;
}

.menu-trigger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
}

.nav {
    display: none;
    position: absolute;
    top: 80px;
    left: 0;
    width: 100%;
    background: #1f2122;
    padding: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1000;
}

.nav.active {
    display: block;
}

.nav.active {
    display: block;
}

.nav li {
    display: block;
    margin: 10px 0;
}

.nav li a {
    color: white;
    font-size: 16px;
    padding: 10px;
    display: block;
}

</style>

<footer>
<div class="container">
<div class="row">
<div class="col-lg-12">
<p>Copyright © 2022 <a href="#">Liberty</a> NFT Marketplace Co., Ltd. All rights reserved.
            
            <a href="https://templatemo.com/privacy-policy" target="_blank">Privacy Policy</a>
            
            <a href="https://templatemo.com/terms-conditions" target="_blank">Terms & Conditions</a>
        </p>
</div>
</div>
</div>
</footer>
<!-- Scripts -->

<!-- Bootstrap core JavaScript -->







<!-- Payment Handling Scripts -->
<!-- Add this CSS somewhere in head or a styles file -->

<!-- Payment script (paste near other scripts) -->

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Choose Payment Method</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="payment-amount">
                    Amount to Pay: <span id="paymentAmount"></span>
</div>
<div class="payment-methods">
<button class="payment-method-btn" onclick="handleUPIPayment()">
<img alt="UPI" src="assets/images/upi-icon.png"/>
<span>UPI / QR Code</span>
</button>
<button class="payment-method-btn" onclick="handleCardPayment()">
<img alt="Card" src="assets/images/card-icon.png"/>
<span>Card / NetBanking</span>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Agreement Modal -->
<div class="modal fade" id="agreementModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Terms & Conditions</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="agreement-content">
    <h6 class="mb-3">Please read and agree to the following terms:</h6>
    <ul class="mb-4">
        <li>I understand that this payment is for the selected product/service.</li>
        <li>I confirm that I am authorized to make this payment.</li>
        <li>NOTICE - during upi payment , if payment less than actual total payment then war begin between you and another person.</li>
        <li>if competitor pay greater then you and service more than you then he win and you lose this service.</li>
        <li>if you pay greater then actual total payment then you win and competitor lose this service.</li>
        <li>I agree to the terms of service and privacy policy.</li>
    </ul>
</div>
<div class="text-center">
    <button class="btn btn-primary" id="agreeBtn">I Agree & Continue</button>
    <button class="btn btn-outline-secondary mt-2" data-bs-dismiss="modal">Cancel</button>
</div>
</div>
</div>
</div>
</div>

<!-- UPI Payment Modal -->
<div class="modal fade" id="upiModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Pay using UPI</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body text-center">
<div class="payment-amount">
    Amount to Pay: <span id="upiAmount"></span>
</div>
<div class="qr-code-container mt-3">
    <img src="assets/images/Gpay-QR.jpg" alt="QR Code" class="img-fluid"/>
</div>
<p class="mb-3 mt-2"><small>UPI ID: <strong>kum444kartik@okicici</strong></small></p>
<div class="upi-apps-title">Or pay directly with:</div>
<div class="upi-apps mt-2">
    <button class="upi-btn" onclick="openUpiApp('gpay')">
        <img alt="GPay" src="assets/images/gpay.png"/>
        <span>Google Pay</span>
    </button>
    <button class="upi-btn" onclick="openUpiApp('phonepe')">
        <img alt="PhonePe" src="assets/images/phonepe.png"/>
        <span>PhonePe</span>
    </button>
    <button class="upi-btn" onclick="openUpiApp('paytm')">
        <img alt="Paytm" src="assets/images/paytm.png"/>
        <span>Paytm</span>
    </button>
    <button class="upi-btn" onclick="openUpiApp('bhim')">
        <img alt="BHIM" src="assets/images/bhim.png"/>
        <span>BHIM</span>
    </button>
</div>
<div class="mt-4">
    <button class="btn btn-primary" id="verifyUPIPaymentBtn" onclick="verifyUPIPayment()">I've paid — Verify Payment</button>
    <button class="btn btn-outline-secondary mt-2" data-bs-dismiss="modal">Cancel</button>
</div>
</div>
</div>
</div>
</div>




<script>
// Initialize currentProduct as a global variable
let currentProduct = {};

// Define category class mapping function
function getCategoryClass(category) {
    const classMap = {
        'iPhone': 'msc',
        'Smartwatch': 'dig',
        'Earphone': 'blc',
        'Laptops': 'vtr'
    };
    return classMap[category] || '';
}

async function loadProducts() {
    // Always try to fetch from API first for live data
    let products = [];
    let fetchError = false;
    
    try {
        // Determine API base URL based on environment
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')
            ? 'http://localhost:3000'
            : 'https://liberty-market.onrender.com';
            
        console.log('Using API base:', API_BASE);
        
        const resp = await fetch(`${API_BASE}/api/products`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache' }
        });
        
        if (!resp.ok) {
            throw new Error(`Server returned ${resp.status}`);
        }
        
        products = await resp.json();
        console.log('Fetched products from API:', products);
        console.log('First product image path:', products[0]?.image);
        console.log('First product structure:', products[0]);
        console.log('First product keys:', products[0] ? Object.keys(products[0]) : 'No products');
        
        // Save to localStorage as backup
        localStorage.setItem('server_products', JSON.stringify(products));
    } catch (err) {
        console.error('Error fetching products from API:', err);
        console.error('Error details:', {
            message: err.message,
            stack: err.stack,
            name: err.name
        });
        fetchError = true;
        
        // Try to get products from localStorage backup
        const serverProducts = JSON.parse(localStorage.getItem('server_products') || '[]');
        if (serverProducts.length > 0) {
            products = serverProducts;
            console.log('Using cached server products from localStorage');
            console.log('First cached product image:', products[0]?.image);
            console.log('First cached product structure:', products[0]);
            console.log('First cached product keys:', products[0] ? Object.keys(products[0]) : 'No products');
        }
    }
    
    // If API fetch failed and no server products in cache, fall back to localStorage products
    if (fetchError && products.length === 0) {
        products = JSON.parse(localStorage.getItem('products') || '[]');
        console.log('Using local products from localStorage');
        console.log('First local product image:', products[0]?.image);
        console.log('First local product structure:', products[0]);
        console.log('First local product keys:', products[0] ? Object.keys(products[0]) : 'No products');
    }
    
    // Map products to display format with consistent property names
    const mappedProducts = products.map(p => {
        console.log('Mapping product:', p);
        const mapped = {
            id: p._id || p.id,
            image: p.image,
            name: p.name,
            Plans: p.plans || p.Plans || '',  // Support both cases
            price: p.price || p.pricePerDay || 0,
            total: p.total || p.totalAmount || 0,
            category: p.category || '',
            categoryClass: (typeof getCategoryClass === 'function') ? getCategoryClass(p.category || '') : '',
            earn: p.earn || p.price || p.pricePerDay || 0,
            days: p.days || p.duration || '30'
        };
        console.log('Mapped to:', mapped);
        return mapped;
    });
    
    console.log('Mapped products:', mappedProducts);
    return mappedProducts;
}


// Menu Trigger Functionality
document.addEventListener('DOMContentLoaded', function() {
  const header = document.querySelector('.header-area .main-nav');
  if (header) {
    // Check if menu trigger already exists
    let menuTrigger = header.querySelector('.menu-trigger');
    
    // If menu trigger doesn't exist, create it
    if (!menuTrigger) {
      menuTrigger = document.createElement('a');
      menuTrigger.className = 'menu-trigger';
      menuTrigger.href = '#';
      
      // Create hamburger icon
      const span1 = document.createElement('span');
      const span2 = document.createElement('span');
      const span3 = document.createElement('span');
      
      menuTrigger.appendChild(span1);
      menuTrigger.appendChild(span2);
      menuTrigger.appendChild(span3);
      
      // Add menu trigger to header
      header.appendChild(menuTrigger);
      
      // Add click event to menu trigger
      menuTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        this.classList.toggle('active');
        const nav = header.querySelector('.nav');
        if (nav) {
          nav.classList.toggle('active');
        }
      });

      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.nav') && !e.target.closest('.menu-trigger')) {
          menuTrigger.classList.remove('active');
          const nav = header.querySelector('.nav');
          if (nav) {
            nav.classList.remove('active');
          }
        }
      });
    }
  }
});

document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOM Content Loaded event fired');
    console.log('Document ready state:', document.readyState);
    console.log('Body element exists:', !!document.body);
    console.log('Product image element exists at load:', !!document.getElementById('product-image'));
    
    // Simple alert to confirm the script is running
    alert('Details page script loaded successfully! Check console for debugging info.');
    
    // Also check on window load
    window.addEventListener('load', function() {
        console.log('Window load event fired');
        console.log('Document ready state on window load:', document.readyState);
        console.log('Product image element exists on window load:', !!document.getElementById('product-image'));
    });
    
    // Check if updateUserBalance function exists before calling it
    if (typeof updateUserBalance === 'function') {
        console.log('updateUserBalance function found, calling it');
        updateUserBalance();
    } else {
        console.log('updateUserBalance function not found');
    }

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    console.log('Current page URL:', window.location.href);
    console.log('URL parameters:', window.location.search);
    console.log('Product ID from URL:', productId);

    if (!productId) {
        console.error('No product ID found in URL');
        return;
    }
    
    // Load all products using the same function as index.html
    console.log('About to call loadProducts()...');
    const products = await loadProducts();
    console.log('All products loaded:', products);
    console.log('Looking for product with ID:', productId);
    
    const product = products.find(p => p.id == productId);
    console.log('Found product:', product);
    
    if (!product) {
        console.error('Product not found!');
        alert('Product not found!');
        return;
    }
    
    // Validate product data
    console.log('Validating product data...');
    if (!product.name) {
        console.error('Product name is missing!');
        product.name = 'Unknown Product';
    }
    if (!product.image) {
        console.error('Product image is missing!');
        product.image = 'assets/images/item-details-01.jpg';
    }
    if (!product.category) {
        console.error('Product category is missing!');
        product.category = 'Unknown Category';
    }
    
    // Test basic DOM manipulation
    console.log('Testing basic DOM manipulation...');
    const testElement = document.getElementById('product-name');
    if (testElement) {
        console.log('Product name element found, setting test text');
        testElement.textContent = 'TESTING - ' + product.name;
    } else {
        console.error('Product name element not found!');
    }

    // Populate all HTML elements with product data
    console.log('Product data:', product);
    console.log('Product image path:', product.image);
    console.log('Product properties:', Object.keys(product));
    console.log('Product image property exists:', 'image' in product);
    console.log('Product image property value:', product.image);
    console.log('Product image property type:', typeof product.image);
    
    const productImageElement = document.getElementById('product-image');
    console.log('Product image element:', productImageElement);
    console.log('All elements with id "product-image":', document.querySelectorAll('#product-image'));
    
    if (productImageElement) {
        console.log('Product image element properties:', {
            tagName: productImageElement.tagName,
            id: productImageElement.id,
            className: productImageElement.className,
            style: productImageElement.style.cssText,
            currentSrc: productImageElement.currentSrc,
            src: productImageElement.src
        });
        
        // Ensure image path is correct
        let imagePath = product.image;
        console.log('Original image path:', imagePath);
        console.log('Image path type:', typeof imagePath);
        
        if (imagePath && !imagePath.startsWith('http') && !imagePath.startsWith('data:')) {
            // If it's a relative path, make sure it starts with the correct path
            if (!imagePath.startsWith('assets/') && !imagePath.startsWith('./assets/')) {
                imagePath = 'assets/images/' + imagePath;
                console.log('Modified image path to:', imagePath);
            }
        }
        
        console.log('Final image path:', imagePath);
        console.log('Setting image src to:', imagePath);
        
        // Test if the image URL is accessible
        if (imagePath && imagePath.startsWith('http')) {
            console.log('Testing HTTP image URL accessibility...');
            fetch(imagePath, { method: 'HEAD' })
                .then(response => {
                    console.log('Image URL test response:', response.status, response.statusText);
                })
                .catch(error => {
                    console.error('Image URL test failed:', error);
                });
        }
        
        productImageElement.src = imagePath;
        productImageElement.alt = product.name;
        
        // Add error handling for image loading
        productImageElement.onerror = function(e) {
            console.error('Failed to load image:', imagePath);
            console.error('Error event:', e);
            console.error('Error target:', e.target);
            console.error('Error type:', e.type);
            
            // Try fallback image
            console.log('Trying fallback image: assets/images/item-details-01.jpg');
            productImageElement.src = 'assets/images/item-details-01.jpg';
        };
        productImageElement.onload = function() {
            console.log('Image loaded successfully:', imagePath);
            console.log('Image dimensions after load:', {
                naturalWidth: productImageElement.naturalWidth,
                naturalHeight: productImageElement.naturalHeight,
                offsetWidth: productImageElement.offsetWidth,
                offsetHeight: productImageElement.offsetHeight,
                clientWidth: productImageElement.clientWidth,
                clientHeight: productImageElement.clientHeight
            });
            
            // Test if image is actually visible
            const rect = productImageElement.getBoundingClientRect();
            console.log('Image bounding rect:', rect);
            console.log('Image is visible:', rect.width > 0 && rect.height > 0);
        };
        
        // Add timeout to check if image loads
        console.log('Setting timeout for image load check...');
        const timeoutId = setTimeout(() => {
            console.log('Timeout fired, checking image status...');
            console.log('Image complete:', productImageElement.complete);
            console.log('Image natural height:', productImageElement.naturalHeight);
            console.log('Image current src:', productImageElement.src);
            console.log('Image computed styles:', {
                display: window.getComputedStyle(productImageElement).display,
                visibility: window.getComputedStyle(productImageElement).visibility,
                opacity: window.getComputedStyle(productImageElement).opacity,
                width: window.getComputedStyle(productImageElement).width,
                height: window.getComputedStyle(productImageElement).height
            });
            
            // Check if image is actually visible
            const rect = productImageElement.getBoundingClientRect();
            console.log('Image bounding rect at timeout:', rect);
            console.log('Image is visible at timeout:', rect.width > 0 && rect.height > 0);
            
            if (productImageElement.complete && productImageElement.naturalHeight === 0) {
                console.error('Image failed to load within timeout, trying fallback');
                productImageElement.src = 'assets/images/item-details-01.jpg';
            }
        }, 5000);
        
        console.log('Timeout ID:', timeoutId);
        
        // Additional debugging - check network requests
        console.log('Checking network requests for image...');
        const performanceEntries = performance.getEntriesByType('resource');
        const imageRequests = performanceEntries.filter(entry => entry.name.includes(imagePath));
        console.log('Image network requests:', imageRequests);
        
        // Check if image is in DOM and visible
        console.log('Image element in DOM:', document.contains(productImageElement));
        console.log('Image parent element:', productImageElement.parentElement);
        console.log('Image parent visibility:', productImageElement.parentElement ? window.getComputedStyle(productImageElement.parentElement).display : 'No parent');
        
        // Force image to be visible
        console.log('Forcing image to be visible...');
        productImageElement.style.display = 'block';
        productImageElement.style.visibility = 'visible';
        productImageElement.style.opacity = '1';
        productImageElement.style.width = 'auto';
        productImageElement.style.height = 'auto';
        
        // Add a border to make it more visible
        productImageElement.style.border = '2px solid red';
        productImageElement.style.backgroundColor = 'yellow';
        
    } else {
        console.error('Product image element not found!');
    }
    
    document.getElementById('product-name').textContent = product.name;
    document.getElementById('product-category').textContent = product.category;
    document.getElementById('product-total').textContent = `₹${product.total || 0}`;
    document.getElementById('due-date').textContent = product.days || '100';
    document.getElementById('plans-text').textContent = product.Plans;
    document.getElementById('product-price').textContent = `₹${product.price || product.earn || 0}`;
    document.getElementById('earn-text').textContent = `Earn ₹${product.earn || product.price || 0} daily`;

    const amountInput = document.getElementById('amount');
    if (amountInput) {
        amountInput.value = product.total || 0;
    }

    // Initialize currentProduct before trying to access its properties
    currentProduct = product;
    
    // Now that currentProduct is initialized, we can set its properties
    if (currentProduct) {
        currentProduct.total = product.total || 0;
        currentProduct.price = product.price || product.earn || 0;
    }
    
    // Remove any existing success modal that might be showing
    const existingSuccessModal = document.querySelector('.success-modal');
    if (existingSuccessModal) {
        existingSuccessModal.remove();
    }
    
    // Set up Apply button functionality
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const amount = document.getElementById('amount').value;
            if (amount) {
                openPaymentModal(amount);
            }
        });
    }
});

</script>

  
  
  
  
  <script src="vendor/jquery/jquery.min.js"></script><script src="vendor/bootstrap/js/bootstrap.min.js"></script><script src="assets/js/isotope.min.js"></script><script src="assets/js/owl-carousel.js"></script><script src="assets/js/tabs.js"></script><script src="assets/js/popup.js"></script><script src="assets/js/custom.js"></script><script>
    /* ---------- CONFIG ---------- */
    // Dynamically determine API base URL based on current domain
    const API_BASE = window.location.hostname.includes('localhost') ? 'http://localhost:3000' : 'https://liberty-market.onrender.com';
    const RAZORPAY_KEY_ID = 'rzp_test_PCS9GocYLB1wd'; // keep in frontend only for Razorpay client init; secret stays on server
    const MERCHANT_UPI_ID = 'liberty@ybl';
    const MERCHANT_NAME = 'Liberty Market';

    /* ---------- UTIL ---------- */
    function $(sel){ return document.querySelector(sel); }
    function showAlert(msg){ alert(msg); } // replace with fancier toast if wanted

    /* ---------- MODAL BUILDERS ---------- */
    function openPaymentModal(amount) {
    // Create modal HTML (Bootstrap) once
    const html = `
    <div class="modal fade" id="modernPaymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">Pay for <small id="modalProductName"></small></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <div class="d-flex align-items-center payment-badge mb-3">
                <img id="modalProductImg" src="" alt="img"/>
                <div>
                <div id="modalPlan" style="font-weight:600"></div>
                <div style="color:#666">Amount: <strong id="modalAmount"></strong></div>
                </div>
            </div>

            <div class="mb-3">
                <button class="btn btn-outline-secondary w-100 mb-2" id="payWithUPIBtn">Pay via UPI / QR</button>
                <button class="btn btn-primary w-100" id="payWithCardBtn">Pay via Card / Netbanking</button>
            </div>

            <div id="paymentStatusArea" class="mt-3" style="display:none">
                <div><span class="spinner-dot"></span> <small id="paymentStatusText">Waiting for confirmation...</small></div>
                <div class="mt-2"><button class="btn btn-sm btn-secondary" id="manualVerifyBtn">I've paid — Verify</button></div>
            </div>
            </div>
        </div>
        </div>
    </div>
    `;
    // append once
    if(!document.getElementById('modernPaymentModal')) {
        const div = document.createElement('div');
        div.innerHTML = html;
        document.body.appendChild(div);
    }

    // Helper function to safely get element
    function getElement(selector) {
        return document.querySelector(selector);
    }
    
    // populate
    const modalProductName = getElement('#modalProductName');
    const modalProductImg = getElement('#modalProductImg');
    const modalPlan = getElement('#modalPlan');
    const modalAmount = getElement('#modalAmount');
    
    if (modalProductName) modalProductName.textContent = currentProduct?.name || 'Item';
    if (modalProductImg) modalProductImg.src = currentProduct?.image || 'assets/images/item-details-01.jpg';
    if (modalPlan) modalPlan.textContent = currentProduct?.plans || currentProduct?.Plans || '';
    if (modalAmount) modalAmount.textContent = `₹${amount}`;

    const modal = new bootstrap.Modal(document.getElementById('modernPaymentModal'));
    modal.show();

    // wire buttons
    const payWithUPIBtn = getElement('#payWithUPIBtn');
    const payWithCardBtn = getElement('#payWithCardBtn');
    const manualVerifyBtn = getElement('#manualVerifyBtn');
    
    if (payWithUPIBtn) {
        payWithUPIBtn.onclick = () => openUPIModal(amount);
    }
    
    if (payWithCardBtn) {
        payWithCardBtn.onclick = () => startRazorpayPayment(amount);
    }
    
    if (manualVerifyBtn) {
        manualVerifyBtn.onclick = () => verifyUPIPaymentManual();
    }
    }

    /* ---------- UPI FLOW (QR) ---------- */
    function openUPIModal(amount) {
    // Simple UPI modal using your existing qr image; you should generate QR server-side for dynamic amt if needed
    const upiHtml = `
    <div class="modal fade" id="upiPayModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title">Pay with UPI</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
            <p>Amount: <strong>₹${amount}</strong></p>
            <img src="assets/images/Gpay-QR.jpg" alt="QR" style="max-width:240px; width:80%; border-radius:8px;"/>
            <p class="mb-3"><small>UPI ID: <strong>kum444kartik@okicici</strong></small></p>
            <div class="upi-apps-title">Or pay directly with:</div>
            <div class="upi-apps mt-2">
                <button class="upi-btn" onclick="openUpiApp('gpay')">
                    <img alt="GPay" src="assets/images/gpay.png"/>
                    <span>Google Pay</span>
                </button>
                <button class="upi-btn" onclick="openUpiApp('phonepe')">
                    <img alt="PhonePe" src="assets/images/phonepe.png"/>
                    <span>PhonePe</span>
                </button>
                <button class="upi-btn" onclick="openUpiApp('paytm')">
                    <img alt="Paytm" src="assets/images/paytm.png"/>
                    <span>Paytm</span>
                </button>
                <button class="upi-btn" onclick="openUpiApp('airtel')">
                    <img alt="Airtel" src="assets/images/airtel.png"/>
                    <span>Airtel Pay</span>
                </button>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary w-100" id="openPaidCheckBtn">I've paid — Check status</button>
                <button class="btn btn-outline-secondary w-100 mt-2" id="closeUpiModalBtn">Cancel</button>
            </div>
            </div>
        </div>
        </div>
    </div>`;
    // append & show
    if(!document.getElementById('upiPayModal')) {
        const div = document.createElement('div');
        div.innerHTML = upiHtml;
        document.body.appendChild(div);
        
        // Add event listeners after creating the modal
        setTimeout(() => {
            const openPaidCheckBtn = document.getElementById('openPaidCheckBtn');
            const closeUpiModalBtn = document.getElementById('closeUpiModalBtn');
            
            if (openPaidCheckBtn) {
                openPaidCheckBtn.onclick = () => {
                    // Close UPI modal
                    bootstrap.Modal.getInstance(document.getElementById('upiPayModal')).hide();
                    // Show payment status
                    const paymentStatusArea = document.getElementById('paymentStatusArea');
                    if (paymentStatusArea) {
                        paymentStatusArea.style.display = 'block';
                    }
                    // Check payment status
                    checkUPIPaymentStatus(amount);
                };
            }
            
            if (closeUpiModalBtn) {
                closeUpiModalBtn.onclick = () => {
                    bootstrap.Modal.getInstance(document.getElementById('upiPayModal')).hide();
                };
            }
        }, 500);
    }
    const modal = new bootstrap.Modal(document.getElementById('upiPayModal'));
    // Try deep-link first (mobile) so a UPI app opens with amount prefilled
    try {
        const tn = encodeURIComponent('Payment for ' + (currentProduct?.name || 'Item'));
        const upiIntent = `upi://pay?pa=${encodeURIComponent(MERCHANT_UPI_ID)}&pn=${encodeURIComponent(MERCHANT_NAME)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${tn}&tr=REF${Date.now()}`;
        // Navigate – on mobile this opens the installed UPI app picker
        window.location.href = upiIntent;
    } catch(_) {}
    // Also show modal as a fallback (desktop/no app)
    modal.show();

    // Try to create a secure Razorpay payment link for UPI
    try {
        fetch(`${API_BASE}/api/initiate-payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ method: 'upi', productId: currentProduct.id, amount: amount, description: currentProduct.name, customer: JSON.parse(localStorage.getItem('currentUser')||'{}') })
        })
        .then(r=>r.json())
        .then(({ link }) => {
            if(link){
                const targetUrl = link.short_url || link.url || link;
                if(targetUrl){ window.open(targetUrl, '_blank'); }
            }
        })
        .catch(()=>{});
    } catch(_) {}

    $('#openPaidCheckBtn').onclick = async () => {
        // show status
        $('#paymentStatusArea').style.display = 'block';
        $('#paymentStatusText').textContent = 'Checking payment, please wait...';
        // create a pending payment record on server (optional) or poll by transaction details
        try {
        const res = await fetch(`${API_BASE}/check-upi?amount=${amount}&productId=${currentProduct.id}`, { method:'GET' });
        const data = await res.json();
        if(data && data.paid) {
            // success
            bootstrap.Modal.getInstance(document.getElementById('upiPayModal')).hide();
            handlePaymentSuccess({ method: 'UPI', txnId: data.txnId || ('upi_'+Date.now()) });
        } else {
            $('#paymentStatusText').textContent = 'Not found yet. Try again in a few seconds or use manual verify.';
        }
        } catch(err) {
        console.error(err);
        $('#paymentStatusText').textContent = 'Error checking status.';
        }
    };
    $('#closeUpiModalBtn').onclick = ()=> bootstrap.Modal.getInstance(document.getElementById('upiPayModal')).hide();
    }

    /* ---------- Manual verify for UPI (fallback) ---------- */
    async function verifyUPIPaymentManual() {
      // For security, manual self-verification is disabled. UPI links are verified via Razorpay/callbacks.
      $('#paymentStatusText').textContent = 'UPI payments are auto-verified after capture. If already paid, please wait a minute or use Card/Netbanking for instant confirmation.';
    }

    /* ---------- Razorpay Card Flow ---------- */
    async function startRazorpayPayment(amount) {
      // Securely create order on backend and open Razorpay checkout
      try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser')||'{}');
        const resp = await fetch(`${API_BASE}/api/initiate-payment`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ productId: currentProduct.id, amount: amount, description: currentProduct.name, method: 'razorpay', customer: { name: currentUser.fullName, email: currentUser.email } })
        });
        const { order } = await resp.json();
        if(!order || !order.id) throw new Error('Order creation failed');

        const options = {
          key: RAZORPAY_KEY_ID,
          amount: order.amount,
          currency: order.currency,
          name: 'Liberty Market',
          description: currentProduct.name,
          image: currentProduct.image || 'assets/images/logo.png',
          order_id: order.id,
          handler: async function (razorResponse) {
            // verify signature + capture on server
            const verifyResp = await fetch(`${API_BASE}/api/verify-payment`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                razorpay_payment_id: razorResponse.razorpay_payment_id,
                razorpay_order_id: razorResponse.razorpay_order_id,
                razorpay_signature: razorResponse.razorpay_signature,
                userId: (JSON.parse(localStorage.getItem('currentUser')||'{}')).id,
                productId: currentProduct.id
              })
            });
            const verifyData = await verifyResp.json();
            if(verifyData && verifyData.success) {
              handlePaymentSuccess({ method: 'card', txnId: verifyData.txnId || razorResponse.razorpay_payment_id });
            } else {
              showAlert('Payment verification failed. Contact support.');
            }
          },
          prefill: {
            name: (JSON.parse(localStorage.getItem('currentUser') || '{}')).fullName || '',
            email: (JSON.parse(localStorage.getItem('currentUser') || '{}')).email || '',
            contact: (JSON.parse(localStorage.getItem('currentUser') || '{}')).phone || ''
          },
          theme: { color: '#7453fc' }
        };
        const rzp = new Razorpay(options);
        rzp.open();
      } catch(err) {
        console.error(err);
        showAlert('Unable to start card payment. Make sure the backend is running at '+API_BASE+' and keys are set.');
      }
    }

    /* ---------- Unified success handler ---------- */
    function handlePaymentSuccess(info) {
    // info: { method: 'card'|'UPI', txnId: '...' }
    // show success modal + update frontend state (call server to give user credit)
    // call server to record transaction
    
    // Ensure currentProduct has consistent id field
    if (currentProduct._id && !currentProduct.id) {
        currentProduct.id = currentProduct._id;
    } else if (!currentProduct.id && !currentProduct._id) {
        // Generate a fallback ID if none exists
        currentProduct.id = 'local_' + Date.now();
    }
    
    // Get current user with consistent id field
    const currentUser = JSON.parse(localStorage.getItem('currentUser')||'{}');
    const userId = currentUser.id || currentUser._id || '';
    
    // Log the transaction details for debugging
    console.log('Recording transaction for product:', currentProduct);
    console.log('User ID:', userId);
    
    fetch(`${API_BASE}/record-transaction`, {
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token') || 'true'}`,
            'X-Admin-Secret': localStorage.getItem('ADMIN_SECRET') || ''
        },
        body: JSON.stringify({
        userId: userId,
        productId: currentProduct.id,
        productName: currentProduct.name,
        amount: currentProduct.total,
        dailyEarning: currentProduct.price,
        method: info.method,
        txnId: info.txnId
        })
    }).then(()=> {
        // show success UI
        const html = `
        <div class="modal fade" id="paymentSuccessModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="success-tick mb-3"><i class="bi bi-check-circle-fill"></i></div>
                <h4>Payment Successful</h4>
                <p class="mb-2">Amount: <strong>₹${currentProduct.total}</strong></p>
                <p class="mb-2">Method: <strong>${info.method}</strong></p>
                <p class="mb-3 text-muted">Daily earning ₹${currentProduct.price} will be credited.</p>
                <button class="btn btn-primary" data-bs-dismiss="modal" onclick="window.location.reload()">Continue</button>
            </div>
            </div>
        </div>`;
        const div = document.createElement('div'); div.innerHTML = html; document.body.appendChild(div);
        new bootstrap.Modal(document.getElementById('paymentSuccessModal')).show();
    }).catch(err => {
        console.error(err);
        // Don’t block UX if recording fails; user already paid
        const html = `
        <div class="modal fade" id="paymentSuccessModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="success-tick mb-3"><i class="bi bi-check-circle-fill"></i></div>
                <h4>Payment Successful</h4>
                <p class="mb-2">Amount: <strong>₹${currentProduct.total}</strong></p>
                <p class="mb-2">Method: <strong>${info.method}</strong></p>
                <p class="mb-3 text-muted">We will sync your transaction shortly.</p>
                <button class="btn btn-primary" data-bs-dismiss="modal" onclick="window.location.reload()">Continue</button>
            </div>
            </div>
        </div>`;
        const div = document.createElement('div'); div.innerHTML = html; document.body.appendChild(div);
        new bootstrap.Modal(document.getElementById('paymentSuccessModal')).show();
    });
    }

    /* ---------- Attach to existing form submit ---------- */
    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('paymentForm');
    if(form) {
        form.onsubmit = function(e) {
        e.preventDefault();
        console.log('Payment form submitted');
        
        // Protect: only logged-in users
        const currentUser = JSON.parse(localStorage.getItem('currentUser')||'null');
        if(!currentUser) { 
            alert('Please login to continue'); 
            window.location.href='login.html'; 
            return; 
        }
        
        // Get amount from input or use product total
        const amountInput = document.getElementById('amount');
        let amount = 0;
        
        if (amountInput && amountInput.value) {
            amount = Number(amountInput.value);
        } else if (currentProduct && currentProduct.total) {
            amount = Number(currentProduct.total);
        } else {
            alert('Please enter a valid amount');
            return;
        }
        
        if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount');
            return;
        }
        
        // Ensure product has the necessary fields
        if (currentProduct) {
            // If the product is from the server (has _id), make sure it has an id field for consistency
            if (currentProduct._id && !currentProduct.id) {
                currentProduct.id = currentProduct._id;
            }
            
            // Ensure total field exists
            if (!currentProduct.total) {
                currentProduct.total = amount;
            }
            
            // Ensure plans/Plans field exists
            if (!currentProduct.plans && !currentProduct.Plans) {
                // If Plans exists with capital P, normalize to lowercase for consistency
                if (currentProduct.Plans) {
                    currentProduct.plans = currentProduct.Plans;
                } else {
                    currentProduct.plans = currentProduct.category || 'Standard';
                }
            }
            
            console.log('Prepared product for payment:', currentProduct);
        }
        
        console.log('Opening payment modal with amount:', amount);
        openPaymentModal(amount);
        };
    } else {
        console.error('Payment form not found');
    }
    });
    </script><script src="https://checkout.razorpay.com/v1/checkout.js"></script><script>
// Function to open payment modal
function openPaymentModal(amount) {
    // Set the amount in the payment modal
    const paymentAmountElement = document.getElementById('paymentAmount');
    if (paymentAmountElement) {
        paymentAmountElement.textContent = '₹' + amount;
    }
    
    // Show the payment modal
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        const bsModal = new bootstrap.Modal(paymentModal);
        bsModal.show();
    } else {
        console.error('Payment modal not found');
        alert('Payment system is currently unavailable. Please try again later.');
    }
}

function handleUPIPayment() {
    // Close payment method selection modal
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        const bsModal = bootstrap.Modal.getInstance(paymentModal);
        if (bsModal) bsModal.hide();
    }
    
    // Show agreement modal first
    const agreementModal = document.getElementById('agreementModal');
    if (!agreementModal) {
        console.error('Agreement modal not found');
        return;
    }
    
    // Show agreement modal
    const agreementBsModal = new bootstrap.Modal(agreementModal);
    agreementBsModal.show();
    
    // Add event listener to agree button
    const agreeBtn = document.getElementById('agreeBtn');
    if (agreeBtn) {
        // Remove any existing event listeners
        const newAgreeBtn = agreeBtn.cloneNode(true);
        agreeBtn.parentNode.replaceChild(newAgreeBtn, agreeBtn);
        
        // Add new event listener
        newAgreeBtn.addEventListener('click', function() {
            // Hide agreement modal
            agreementBsModal.hide();
            
            // Show UPI modal
            showUPIModal();
        });
    }
}

function showUPIModal() {
    // Get the UPI modal element
    const upiModal = document.getElementById('upiModal');
    if (!upiModal) {
        console.error('UPI modal not found');
        return;
    }
    
    // Format the amount with rupee symbol
    const formattedAmount = currentProduct && currentProduct.total ? 
        '₹' + parseFloat(currentProduct.total).toFixed(2) : '₹0.00';
    
    // Set the amount in the UPI modal
    const upiAmountElement = document.getElementById('upiAmount');
    if (upiAmountElement) {
        upiAmountElement.textContent = formattedAmount;
    }
    
    // Show the UPI modal
    const upiModalInstance = new bootstrap.Modal(upiModal);
    upiModalInstance.show();
    
    // Enable the verify payment button after a UPI app is clicked
    const verifyUPIPaymentBtn = document.getElementById('verifyUPIPaymentBtn');
    if (verifyUPIPaymentBtn) {
        // Initially enable the verify payment button to allow manual verification
        verifyUPIPaymentBtn.disabled = false;
        verifyUPIPaymentBtn.classList.add('btn-primary');
        verifyUPIPaymentBtn.classList.remove('btn-secondary');
    }
        
        // This section is now handled in the showUPIModal function
        
        // Add event listener to verify payment button
        const paymentVerifyBtn = document.getElementById('verifyUPIPaymentBtn');
        if (paymentVerifyBtn) {
            paymentVerifyBtn.addEventListener('click', function() {
                verifyUPIPayment();
            });
            
            // Enable the button after user clicks on any UPI payment option
            const upiButtons = document.querySelectorAll('.upi-btn');
            upiButtons.forEach(button => {
                button.addEventListener('click', function() {
                    verifyUPIPaymentBtn.disabled = false;
                    verifyUPIPaymentBtn.classList.add('btn-primary');
                    verifyUPIPaymentBtn.classList.remove('btn-secondary');
                });
            });
        }
    }


// Function to check UPI payment status
function checkUPIPaymentStatus(amount) {
    // Remove any existing loading overlay
    const existingOverlay = document.getElementById('loadingOverlay');
    if (existingOverlay) {
        existingOverlay.remove();
    }
    
    // Create a new loading overlay with better UI
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loadingOverlay';
    loadingOverlay.style.position = 'fixed';
    loadingOverlay.style.top = '0';
    loadingOverlay.style.left = '0';
    loadingOverlay.style.width = '100%';
    loadingOverlay.style.height = '100%';
    loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    loadingOverlay.style.display = 'flex';
    loadingOverlay.style.justifyContent = 'center';
    loadingOverlay.style.alignItems = 'center';
    loadingOverlay.style.zIndex = '9999';
    
    const loadingContent = document.createElement('div');
    loadingContent.style.backgroundColor = '#fff';
    loadingContent.style.padding = '30px';
    loadingContent.style.borderRadius = '10px';
    loadingContent.style.textAlign = 'center';
    loadingContent.style.maxWidth = '80%';
    loadingContent.innerHTML = `
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-4 mb-3">Verifying Payment</h4>
        <p>Please wait while we confirm your payment...</p>
    `;
    
    loadingOverlay.appendChild(loadingContent);
    document.body.appendChild(loadingOverlay);
    
    // Disable verify button during checking
    const verifyButton = document.getElementById('verifyUPIPaymentBtn');
    if (verifyButton) {
        verifyButton.disabled = true;
        verifyButton.textContent = 'Verifying...';
    }
    
    // Simulate API call to check payment status
    setTimeout(() => {
        // Remove the loading overlay
        loadingOverlay.remove();
        
        // In a real implementation, you would make an API call to check the payment status
        // For demo purposes, we'll use a confirmation dialog to simulate payment verification
        const success = confirm('Did you complete the payment? Click OK if you have made the payment, or Cancel if you need to try again.');
        
        if (success) {
            // Create success overlay
            const successOverlay = document.createElement('div');
            successOverlay.style.position = 'fixed';
            successOverlay.style.top = '0';
            successOverlay.style.left = '0';
            successOverlay.style.width = '100%';
            successOverlay.style.height = '100%';
            successOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            successOverlay.style.display = 'flex';
            successOverlay.style.justifyContent = 'center';
            successOverlay.style.alignItems = 'center';
            successOverlay.style.zIndex = '9999';
            
            const successContent = document.createElement('div');
            successContent.style.backgroundColor = '#fff';
            successContent.style.padding = '30px';
            successContent.style.borderRadius = '10px';
            successContent.style.textAlign = 'center';
            successContent.style.maxWidth = '80%';
            successContent.innerHTML = `
                <div class="text-success mb-3" style="font-size: 4rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-success mb-3">Payment Successful!</h3>
                <p>Your payment of ₹${amount} has been received.</p>
                <p>Transaction ID: UPI${Date.now()}</p>
                <button class="btn btn-primary mt-3" onclick="window.location.href='explore.html'">Continue Shopping</button>
            `;
            
            successOverlay.appendChild(successContent);
            document.body.appendChild(successOverlay);
            
            // Record the payment
            recordSuccessfulPayment({
                method: 'UPI',
                txnId: 'UPI' + Date.now(),
                amount: amount
            });
            
            // Close the UPI modal
            const upiModal = document.getElementById('upiModal');
            if (upiModal) {
                const modalInstance = bootstrap.Modal.getInstance(upiModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            
            // Remove success overlay after 5 seconds
            setTimeout(() => {
                successOverlay.remove();
            }, 5000);
        } else {
            // Re-enable verify button
            if (verifyButton) {
                verifyButton.disabled = false;
                verifyButton.textContent = 'I\'ve paid — Verify Payment';
            }
            
            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-warning';
            errorMsg.textContent = 'Payment verification failed. Please try again or choose another payment method.';
            errorMsg.style.marginTop = '15px';
            
            // Add the error message to the modal
            const modalBody = document.querySelector('#upiModal .modal-body');
            if (modalBody) {
                // Remove any existing error message
                const existingError = modalBody.querySelector('.alert');
                if (existingError) {
                    existingError.remove();
                }
                
                modalBody.appendChild(errorMsg);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    errorMsg.remove();
                }, 5000);
            }
        }
    }, 3000); // Simulate 3 second verification time
}

function handleCardPayment() {
    // Close payment method selection modal
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        const bsModal = bootstrap.Modal.getInstance(paymentModal);
        if (bsModal) bsModal.hide();
    }
    
    // Start Razorpay payment with the current product total
    if (currentProduct && currentProduct.total) {
        startRazorpayPayment(parseFloat(currentProduct.total));
    } else {
        alert('Invalid product amount');
    }
}

function openUpiApp(app) {
    const upiId = 'kum444kartik@okicici'; // Your UPI ID
    const merchantName = 'Liberty Market';
    const amount = currentProduct && currentProduct.total ? currentProduct.total : '100';
    const transactionNote = currentProduct && currentProduct.name ? `Payment for ${currentProduct.name}` : 'Payment';
    const transactionRef = `REF${Date.now()}`;
    
    // Create app-specific URLs for better compatibility// For Google Pay specifically
    let appUrl = `tez://upi/pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;   '';
    let universalUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(transactionNote)}&tr=${encodeURIComponent(transactionRef)}`;
    
    // Create app-specific URLs for better compatibility
    switch(app) {
        case 'gpay':
            // Google Pay specific format - using the universal format for better compatibility
            appUrl = universalUrl;
            break;
        case 'phonepe':
            appUrl = `phonepe://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            break;
        case 'paytm':
            appUrl = `paytmmp://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            break;
        case 'bhim':
            appUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            break;
        default:
            // Use the universal URL for other apps
            appUrl = universalUrl;
    }
    
    // Show a message to the user
    const statusMsg = document.createElement('div');
    statusMsg.className = 'upi-status-message';
    statusMsg.textContent = `Opening ${app} app...`;
    statusMsg.style.backgroundColor = '#f8f9fa';
    statusMsg.style.color = '#333';
    statusMsg.style.padding = '10px';
    statusMsg.style.borderRadius = '8px';
    statusMsg.style.marginTop = '15px';
    statusMsg.style.textAlign = 'center';
    statusMsg.style.fontWeight = 'bold';
    
    // Add the message to the page
    const upiAppsElement = document.querySelector('.upi-apps');
    if (upiAppsElement) {
        upiAppsElement.insertAdjacentElement('afterend', statusMsg);
    }
    
    // Create a clickable link as a fallback
    const fallbackLink = document.createElement('a');
    fallbackLink.href = universalUrl;
    fallbackLink.id = 'fallbackUpiLink';
    fallbackLink.textContent = 'Click here if app doesn\'t open automatically';
    fallbackLink.style.display = 'block';
    fallbackLink.style.marginTop = '10px';
    fallbackLink.style.textAlign = 'center';
    fallbackLink.style.color = '#7453fc';
    fallbackLink.style.textDecoration = 'underline';
    
    // Add the fallback link after the status message
    if (statusMsg) {
        statusMsg.insertAdjacentElement('afterend', fallbackLink);
    }
    
    // For mobile detection
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    if (isMobile) {
        // On mobile, directly open the URL
        window.location.href = appUrl;
    } else {
        // On desktop, show a message that this requires a mobile device
        alert('UPI payments require a mobile device with the appropriate app installed. Please scan the QR code with your UPI app instead.');
    }
    
    // Enable the verify payment button immediately
    const verifyUPIPaymentBtn = document.getElementById('verifyUPIPaymentBtn');
    if (verifyUPIPaymentBtn) {
        verifyUPIPaymentBtn.disabled = false;
        verifyUPIPaymentBtn.classList.add('btn-primary');
        verifyUPIPaymentBtn.classList.remove('btn-secondary');
    }
    
    // Remove the message and fallback link after 15 seconds
    setTimeout(() => {
        if (statusMsg) statusMsg.remove();
        const fallbackLink = document.getElementById('fallbackUpiLink');
        if (fallbackLink) fallbackLink.remove();
    }, 15000);
}

function verifyUPIPayment() {
    // Get current user
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (!currentUser || !currentUser.id) {
        alert('Please login to continue');
        window.location.href = 'login.html';
        return;
    }
    
    // Get the payment amount
    const amountElement = document.getElementById('upiAmount');
    const amount = amountElement ? amountElement.textContent.replace('₹', '') : 
                  (currentProduct && currentProduct.total ? currentProduct.total : '100');
    
    // Disable the verify button to prevent multiple clicks
    const verifyButton = document.getElementById('verifyUPIPaymentBtn');
    if (verifyButton) {
        verifyButton.disabled = true;
        verifyButton.textContent = 'Verifying...';
        verifyButton.classList.add('btn-secondary');
        verifyButton.classList.remove('btn-primary');
    }
    
    // Call the checkUPIPaymentStatus function to verify payment
    checkUPIPaymentStatus(parseFloat(amount));
}


// Function to start Razorpay payment
function startRazorpayPayment(amount) {
    console.log('Starting Razorpay payment with amount:', amount);
    
    // Get current user
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    // Create Razorpay options
    const options = {
        key: RAZORPAY_KEY, // Use the global variable defined at the top
        amount: amount * 100, // Convert to paise
        currency: 'INR',
        name: 'Liberty Market',
        description: currentProduct ? `Payment for ${currentProduct.name}` : 'Product Payment',
        image: 'assets/images/logo.png',
        handler: function(response) {
            console.log('Payment successful:', response);
            // Record successful payment
            recordSuccessfulPayment({
                method: 'Razorpay',
                txnId: response.razorpay_payment_id,
                amount: amount
            });
        },
        modal: {
            ondismiss: function() {
                console.log('Payment modal closed');
            }
        },
        prefill: {
            name: currentUser.name || '',
            email: currentUser.email || '',
            contact: currentUser.phone || ''
        },
        theme: {
            color: '#7453fc'
        }
    };
    
    // Initialize Razorpay and open payment modal
    try {
        const rzp = new Razorpay(options);
        rzp.open();
        
        // Close any open modals
        const modernPaymentModal = document.getElementById('modernPaymentModal');
        if (modernPaymentModal) {
            const bsModal = bootstrap.Modal.getInstance(modernPaymentModal);
            if (bsModal) bsModal.hide();
        }
    } catch (error) {
        console.error('Razorpay initialization error:', error);
        alert('Payment initialization failed. Please try again.');
    }

    // Function to record successful payment
    function recordSuccessfulPayment(info) {
        console.log('Recording successful payment:', info);
        
        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
         } else {
            console.error('Loading overlay element not found');
        }
        
        // Get current user
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        // Create transaction record
        const transaction = {
            id: Date.now(),
            productId: currentProduct?.id || '',
            productName: currentProduct?.name || 'Product',
            amount: info.amount,
            date: new Date().toISOString(),
            dailyEarning: currentProduct?.price || 0,
            paymentMethod: info.method,
            txnId: info.txnId,
            status: 'completed',
            userId: currentUser.id || currentUser._id || ''
        };
        
        console.log('Transaction record:', transaction);
        
        // Send transaction to backend API
        fetch('http://localhost:3000/record-transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(transaction)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Transaction recorded in backend:', data);
        })
        .catch(error => {
            console.error('Error recording transaction in backend:', error);
            // Fallback to localStorage if API fails
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
        });
        
        // Always store in localStorage as backup
        const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
        transactions.push(transaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        
        // Update user balance
        if (currentUser) {
            currentUser.balance = (currentUser.balance || 0) + Number(currentProduct?.price || 0);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        // Setup daily earnings update
        setupDailyEarningsUpdate(transaction);
        
        // Hide loading overlay
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        
        // Show success message and then redirect to profile page
        showSuccessModal(info);
        
        // Set a timeout to redirect to profile page after showing the success modal
        setTimeout(() => {
            window.location.href = 'profile.html';
        }, 3000); // Redirect after 3 seconds
    }
}

// Function to show success modal
function showSuccessModal(info) {
    console.log('Showing success modal with info:', info);
    
    // Only show success modal if payment information is provided
    if (!info || !info.amount || !info.method) {
        console.error('Cannot show success modal: Missing payment information');
        return;
    }
    
    // Create success modal if it doesn't exist
    let successModal = document.querySelector('.success-modal');
    
    if (!successModal) {
        successModal = document.createElement('div');
        successModal.className = 'success-modal';
        document.body.appendChild(successModal);
    }
    
    // Update modal content
    successModal.innerHTML = `
        <h3>Payment Successful!</h3>
        <div class="success-details">
            <p>Amount: <span>₹${info.amount}</span></p>
            <p>Method: <span>${info.method}</span></p>
            <p>Daily Earning: <span>₹${currentProduct?.price || 0}</span></p>
        </div>
        <button id="closeSuccessBtn">Continue</button>
    `;
    
    // Show the modal
    successModal.style.display = 'block';
    
    // Hide loading overlay if it's visible
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
    
    // Close any open modals
    const modals = ['paymentModal', 'upiModal'];
    modals.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const bsModal = bootstrap.Modal.getInstance(modalElement);
            if (bsModal) bsModal.hide();
        }
    });
    
    // Add event listener to close button
    document.getElementById('closeSuccessBtn').addEventListener('click', function() {
        successModal.style.display = 'none';
        // Redirect to profile page instead of reloading
        window.location.href = 'profile.html';
    });
}

// Function to setup daily earnings update
function setupDailyEarningsUpdate(transaction) {
    console.log('Setting up daily earnings update for transaction:', transaction);
    
    // Get existing earning intervals from localStorage
    const earningIntervals = JSON.parse(localStorage.getItem('earningIntervals') || '[]');
    
    // Add new interval
    earningIntervals.push({
        transactionId: transaction.id,
        productId: transaction.productId,
        dailyEarning: transaction.dailyEarning,
        startDate: new Date().toISOString(),
        userId: transaction.userId
    });
    
    // Save to localStorage
    localStorage.setItem('earningIntervals', JSON.stringify(earningIntervals));
    console.log('Earning intervals updated:', earningIntervals);
}

// Function to update user balance with daily earnings
function updateUserBalance() {
    console.log('Updating user balance with daily earnings');
    
    // Get current user
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (!currentUser || !currentUser.id) {
        console.log('No logged in user found');
        return;
    }
    
    // Get earning intervals
    const earningIntervals = JSON.parse(localStorage.getItem('earningIntervals') || '[]');
    if (earningIntervals.length === 0) {
        console.log('No earning intervals found');
        return;
    }
    
    // Get last update time
    const lastUpdateTime = localStorage.getItem('lastBalanceUpdateTime');
    const now = new Date();
    
    // If last update was today, don't update again
    if (lastUpdateTime) {
        const lastUpdate = new Date(lastUpdateTime);
        if (lastUpdate.toDateString() === now.toDateString()) {
            console.log('Balance already updated today');
            return;
        }
    }
    
    // Calculate earnings for current user
    let totalEarnings = 0;
    earningIntervals.forEach(interval => {
        if (interval.userId === currentUser.id || interval.userId === currentUser._id) {
            totalEarnings += Number(interval.dailyEarning || 0);
        }
    });
    
    // Update user balance
    if (totalEarnings > 0) {
        currentUser.balance = (currentUser.balance || 0) + totalEarnings;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        console.log(`User balance updated: +₹${totalEarnings}`);
        
        // Show notification
        alert(`Daily earnings of ₹${totalEarnings} has been credited to your account!`);
    }
    
    // Update last update time
    localStorage.setItem('lastBalanceUpdateTime', now.toISOString());
}

// Setup daily earnings update
function recordSuccessfulPayment(transaction) {
    setupDailyEarningsUpdate(transaction);
}

function checkUPIPaymentStatus() {
    // Simulate API call to check payment status
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            // For demo, randomly succeed or fail
            const success = Math.random() > 0.3; // 70% success rate
            if (success) {
                resolve(true);
            } else {
                reject(new Error('Payment verification failed'));
            }
        }, 2000);
    }).catch(error => {
        console.error('Error:', error);
        alert('Payment verification failed. Please contact support.');
        
        try {
            // Attempt to hide loading state
            hideLoadingState();
        } catch (err) {
            console.error('Error hiding loading state:', err);
        }
    });
}

function updateUserData(transaction) {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const userIndex = users.findIndex(u => u.id === currentUser.id);
    
    if (userIndex !== -1) {
        // Initialize transactions array if doesn't exist
        if (!users[userIndex].transactions) {
            users[userIndex].transactions = [];
        }
        
        // Add transaction
        users[userIndex].transactions.push(transaction);
        
        // Update balance
        users[userIndex].balance = (users[userIndex].balance || 0) + Number(currentProduct.price);
        
        // Update daily earnings tracking
        if (!users[userIndex].dailyEarnings) {
            users[userIndex].dailyEarnings = [];
        }
        users[userIndex].dailyEarnings.push({
            productId: currentProduct.id,
            amount: currentProduct.price,
            startDate: new Date().toISOString(),
            lastUpdate: new Date().toISOString()
        });
        
        // Save updates
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('currentUser', JSON.stringify(users[userIndex]));
    }
}

function setupDailyEarningsUpdate(transaction) {
    // Set up interval to update balance daily
    if (!window.earningIntervals) {
        window.earningIntervals = {};
    }
    
    window.earningIntervals[transaction.id] = setInterval(() => {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const userIndex = users.findIndex(u => u.id === currentUser.id);

        if (userIndex !== -1) {
            // Add daily earning to balance
            users[userIndex].balance += Number(transaction.dailyEarning);
            
            // Update last update timestamp
            const earningIndex = users[userIndex].dailyEarnings.findIndex(
                e => e.productId === transaction.productId
            );
            if (earningIndex !== -1) {
                users[userIndex].dailyEarnings[earningIndex].lastUpdate = new Date().toISOString();
            }
            
            // Save updates
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(users[userIndex]));
            
            // Update UI if on profile page
            if (document.getElementById('currentBalance')) {
                document.getElementById('currentBalance').textContent = 
                    '₹' + users[userIndex].balance;
            }
        }
    }, 24 * 60 * 60 * 1000); // Run every 24 hours
}

function showLoadingState() {
    // Create loading overlay if it doesn't exist
    if (!document.getElementById('loadingOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Processing Payment...</div>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoadingState() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}
</script>


<!-- Add before closing body tag -->
<script>
function updateUserBalance() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    if (!currentUser || !currentUser.id) {
        console.log('No logged in user found');
        return;
    }
    
    fetch(`http://localhost:3000/api/user-stats/${currentUser.id || currentUser._id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const userBalanceAmount = document.getElementById('userBalanceAmount');
            if (userBalanceAmount) {
                userBalanceAmount.textContent = '₹' + (data.balance || 0);
            }
            
            currentUser.balance = data.balance || 0;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            console.log('User balance updated from API');
        })
        .catch(error => {
            console.error('Error fetching user stats:', error);
            const userBalanceAmount = document.getElementById('userBalanceAmount');
            if (userBalanceAmount) {
                userBalanceAmount.textContent = '₹' + (currentUser.balance || 0);
            }
        });
}

document.addEventListener('DOMContentLoaded', function() {
    updateUserBalance();
});
</script>

</body>
</html>