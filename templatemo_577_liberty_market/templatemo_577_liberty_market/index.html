<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="author" content="templatemo">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

    <title>Marketplace - investloom7x</title>


    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">


    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet"href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>
<!--

TemplateMo 577 Liberty Market

https://templatemo.com/tm-577-liberty-market

-->

  </style>
  </head>

  <body>
  <!-- Common JavaScript Functions -->
  <script src="assets/js/common.js"></script>
  <!-- ***** Preloader Start ***** -->
  <div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
      <span class="dot"></span>
      <div class="dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
  <!-- ***** Preloader End ***** -->

  <!-- ***** Header Area Start ***** -->
  <header class="header-area header-sticky">
    <div class="menu-trigger" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <nav class="main-nav">
                      <!-- ***** Logo Start ***** -->
                      <div class="text-center logo-container">
                          <a href="index.html" class="logo">
                              <img src="assets/images/logo.png" alt="">
                          </a>
                      </div>
                      <!-- ***** Logo End ***** -->
                      
                      <!-- ***** Menu Start ***** -->
                      <ul class="nav">
                          <li><a href="index.html" class="active">Home</a></li>
                          <li><a href="profile.html">Profile</a></li>
                          <li><a href="Host-WEB/admin_Login_page.html">Admin</a></li>
                          <li><a href="signup.html">Logout</a></li>

                      </ul>
                      <!-- ***** Menu End ***** -->
                  </nav>
              </div>
          </div>
      </div>
  </header>
  <!-- ***** Header Area End ***** -->

  <!-- ***** Side Navigation -->
  <div class="side-nav">
    <div class="side-nav-item" onclick="window.location.href='index.html'">
      <div class="side-nav-icon">
        <i class="fa fa-home"></i>
      </div>
      <div class="side-nav-text">Home</div>
    </div>
    <div class="side-nav-item" onclick="window.location.href='profile.html'">
      <div class="side-nav-icon">
        <i class="fa fa-user"></i>
      </div>
      <div class="side-nav-text">Profile</div>
    </div>
    <div class="side-nav-item" onclick="window.location.href='Host-WEB/admin_Login_page.html'">
      <div class="side-nav-icon">
        <i class="fa fa-cog"></i>
      </div>
      <div class="side-nav-text">Admin</div>
    </div>
  </div>

  <!-- ***** Main Banner Area Start ***** -->
  <div class="main-banner">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 align-self-center">
          <div class="user-account-info" id="userAccountInfo">
              <div class="user-profile-pic">
                <img src="assets/images/author.jpg" alt="Profile" id="userProfilePic">
              </div>
              <div class="user-balance-info">
                <div class="balance-amount" id="userBalanceAmount">₹0</div>
                <div class="balance-label">Available Balance</div>
              </div>
          </div>
          <div class="header-text">
            <h1>TRADING in INVESTLOOM7X</h1>
            <p> <h4>investloom7x can be freely downloaded and supportive.</h4></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ***** Main Banner Area End ***** -->

  <!-- Deposit Modal -->
  <div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="depositModalLabel">Deposit Money</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="depositAmount" class="form-label">Enter Amount (₹)</label>
            <input type="number" class="form-control" id="depositAmount" min="100" step="100" required>
          </div>
          
          <div class="quick-amounts mb-3">
            <button class="btn btn-outline-primary me-2" onclick="setAmount(500)">₹500</button>
            <button class="btn btn-outline-primary me-2" onclick="setAmount(1000)">₹1000</button>
            <button class="btn btn-outline-primary me-2" onclick="setAmount(2000)">₹2000</button>
            <button class="btn btn-outline-primary" onclick="setAmount(5000)">₹5000</button>
          </div>

          <div class="payment-options mb-3">
            <h6>Select Payment Method</h6>
            <div class="payment-grid">
              <div class="payment-option" onclick="selectPayment('gpay')">
                <img src="assets/images/gpay.svg" alt="Google Pay">
                <span>Google Pay</span>
              </div>
              <div class="payment-option" onclick="selectPayment('phonepe')">
                <img src="assets/images/phonepe.svg" alt="PhonePe">
                <span>PhonePe</span>
              </div>
              <div class="payment-option" onclick="selectPayment('paytm')">
                <img src="assets/images/paytm.svg" alt="Paytm">
                <span>Paytm</span>
              </div>
            </div>
          </div>

          <div id="paymentInstructions" class="d-none">
            <div class="alert alert-info">
              <p class="mb-2">Please follow these steps:</p>
              <ol class="mb-0">
                <li>Open your payment app</li>
                <li>Scan the QR code below</li>
                <li>Enter the amount: ₹<span id="confirmAmount">0</span></li>
                <li>Complete the payment</li>
                <li>Click 'Confirm Deposit' below</li>
              </ol>
            </div>
            <div class="qr-code text-center my-3">
              <img src="assets/images/qr-code.svg" alt="QR Code" style="width: 200px;">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="confirmDeposit()">Confirm Deposit</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ***** Real-time Updates Info End ***** -->
  
  <div class="categories-collections">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="categories">
            <div class="row">
              <div class="col-lg-12">
                <div class="section-heading">
                  <div class="line-dec"></div>
                  <h2>Browse Through Our <em>Categories</em> Here.</h2>
                </div>
              </div>
              <div class="col-lg-3 col-sm-3 col-6">
                <div class="item">
                  <div class="icon">
                    <img src="assets/images/icon-01.png" alt="">
                  </div>
                  <h4>EMI</h4>
                  <div class="icon-button">
                    <a href="#" onclick="showEMICalculator()"><i class="fa fa-angle-right"></i></a>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-sm-3 col-6">
                <div class="item">
                  <div class="icon">
                    <img src="assets/images/icon-02.png" alt="">
                  </div>
                  <h4>Deposit</h4>
                  <div class="icon-button">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#depositModal"><i class="fa fa-angle-right"></i></a>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-sm-3 col-6">
                <div class="item">
                  <div class="icon">
                    <img src="assets/images/icon-03.png" alt="">
                  </div>
                  <h4>Withdraw</h4>
                  <div class="icon-button">
                    <a href="#" onclick="handleWithdrawal()"><i class="fa fa-angle-right"></i></a>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-sm-3 col-6">
                <div class="item">
                  <div class="icon">
                    <img src="assets/images/icon-05.png" alt="">
                  </div>
                  <h4>Balance</h4>
                  <div class="icon-button" onclick="window.location.href='profile.html'">
                    <a href="#" onclick="showProfile()"><i class="fa fa-angle-right"></i></a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ***** Currently Market Area End ***** -->


  <div class="currently-market">
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="section-heading">
                    <div class="line-dec"></div>
                    <h2><em>Items</em> Currently In The Market</h2>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="filters">
                    <ul>
                        <li data-filter="*" class="active">All</li>
                        <li data-filter=".msc">+5K</li>
                        <li data-filter=".dig">+10K</li>
                        <li data-filter=".blc">+20K</li>
                        <li data-filter=".vtr">+40K</li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-12">
            <div class="row currently-market-items">
              <!-- Products will be loaded here by JavaScript -->
            </div>
          </div>
        </div>
    </div>
  </div>

  <script>
  // Deposit functionality
  function setAmount(amount) {
    document.getElementById('depositAmount').value = amount;
    document.getElementById('confirmAmount').textContent = amount;
  }

  // UPI app package names
  const UPI_APPS = {
    'gpay': 'com.google.android.apps.nbu.paisa.user',
    'phonepe': 'com.phonepe.app',
    'paytm': 'net.one97.paytm'
  };

  let paymentCheckInterval;
  let transactionId;

  function selectPayment(method) {
    // Remove active class from all payment options
    document.querySelectorAll('.payment-option').forEach(option => {
      option.classList.remove('active');
    });

    // Add active class to selected payment option
    const selectedOption = document.querySelector(`.payment-option[onclick*="${method}"]`);
    if (selectedOption) {
      selectedOption.classList.add('active');
    }

    // Show payment instructions
    const amount = document.getElementById('depositAmount').value || 0;
    document.getElementById('confirmAmount').textContent = amount;
    document.getElementById('paymentInstructions').classList.remove('d-none');

    // Store selected payment method
    localStorage.setItem('selectedPaymentMethod', method);
  }

  function generateTransactionId() {
    return 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  function launchUPIApp(amount, paymentMethod) {
    const merchantUpiId = 'merchant@upi'; // Replace with your actual UPI ID
    const merchantName = 'InvestLoom7x';
    transactionId = generateTransactionId();

    // Construct UPI URL
    const upiUrl = `upi://pay?pa=${merchantUpiId}&pn=${merchantName}&am=${amount}&tr=${transactionId}&cu=INR`;

    // Create and click a hidden link to launch the UPI app
    const link = document.createElement('a');
    link.href = upiUrl;
    link.click();

    // Start checking for payment status
    startPaymentStatusCheck(transactionId, amount);
  }

  function startPaymentStatusCheck(txnId, amount) {
    let attempts = 0;
    const maxAttempts = 60; // 2 minutes (checking every 2 seconds)

    paymentCheckInterval = setInterval(() => {
      attempts++;
      // Simulate checking payment status with your backend
      checkPaymentStatus(txnId).then(status => {
        if (status === 'SUCCESS') {
          clearInterval(paymentCheckInterval);
          handleSuccessfulPayment(amount);
        } else if (status === 'FAILED') {
          clearInterval(paymentCheckInterval);
          handleFailedPayment();
        } else if (attempts >= maxAttempts) {
          clearInterval(paymentCheckInterval);
          handlePaymentTimeout();
        }
      });
    }, 2000);
  }

  async function checkPaymentStatus(txnId) {
    // This is a mock implementation. In production, this should make an API call to your backend
    // which would then check with your payment provider for the actual status
    return new Promise(resolve => {
      // Simulate random success/failure for demo purposes
      const random = Math.random();
      if (random > 0.7) resolve('SUCCESS');
      else if (random > 0.4) resolve('PENDING');
      else resolve('FAILED');
    });
  }

  function handleSuccessfulPayment(amount) {
    // Get current user and balance
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
      alert('Please log in to continue');
      return;
    }

    // Update balance
    const currentBalance = parseFloat(currentUser.balance || 0);
    const newBalance = currentBalance + amount;
    currentUser.balance = newBalance;

    // Save updated user data
    localStorage.setItem('currentUser', JSON.stringify(currentUser));

    // Add transaction record
    const transaction = {
      type: 'deposit',
      amount: amount,
      date: new Date().toISOString(),
      status: 'completed',
      transactionId: transactionId,
      paymentMethod: localStorage.getItem('selectedPaymentMethod')
    };

    let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
    transactions.push(transaction);
    localStorage.setItem('transactions', JSON.stringify(transactions));

    // Update UI
    document.getElementById('userBalanceAmount').textContent = `₹${newBalance}`;

    // Close modal and show success message
    const depositModal = bootstrap.Modal.getInstance(document.getElementById('depositModal'));
    depositModal.hide();
    alert(`Successfully deposited ₹${amount}. Your new balance is ₹${newBalance}`);

    // Reset form
    resetDepositForm();
  }

  function handleFailedPayment() {
    alert('Payment failed. Please try again.');
    resetDepositForm();
  }

  function handlePaymentTimeout() {
    alert('Payment timeout. Please try again.');
    resetDepositForm();
  }

  function resetDepositForm() {
    document.getElementById('depositAmount').value = '';
    document.getElementById('paymentInstructions').classList.add('d-none');
    document.querySelectorAll('.payment-option').forEach(option => {
      option.classList.remove('active');
    });
    localStorage.removeItem('selectedPaymentMethod');
  }

  function confirmDeposit() {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    if (!amount || amount < 100) {
      alert('Please enter a valid amount (minimum ₹100)');
      return;
    }

    const selectedPayment = document.querySelector('.payment-option.active');
    if (!selectedPayment) {
      alert('Please select a payment method');
      return;
    }

    const paymentMethod = localStorage.getItem('selectedPaymentMethod');
    if (!paymentMethod) {
      alert('Please select a payment method');
      return;
    }

    // Launch UPI app with payment details
    launchUPIApp(amount, paymentMethod);
  }

  // Initialize user balance on page load
  document.addEventListener('DOMContentLoaded', function() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (currentUser && currentUser.balance) {
      document.getElementById('userBalanceAmount').textContent = `₹${currentUser.balance}`;
    }
  });

  const API_BASE = 'http://localhost:3000';
  
  // Initialize products when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Add sample products to localStorage if none exist
    const existingProducts = JSON.parse(localStorage.getItem('products') || '[]');
    if (existingProducts.length === 0) {
      const sampleProducts = [
        {
          id: 1001,
          image: 'assets/images/featured-01.jpg',
          name: 'Tester Plan',
          category: 'iPhone',
          price: '30',
          total: '100',
          categoryClass: 'msc',
          Plans: 'Tester Plan'
        },
        {
          id: 1002,
          image: 'assets/images/featured-02.jpg',
          name: 'VIP 1 Plan',
          category: 'Smartwatch',
          price: '20000',
          total: '55000',
          categoryClass: 'dig',
          Plans: 'VIP 1 Plan'
        }
      ];
      localStorage.setItem('products', JSON.stringify(sampleProducts));
      console.log('Added sample products to localStorage');
    }
    
    loadProducts();
    
    // Add responsive handling
    handleResponsiveLayout();
  });
  
  // Handle responsive layout changes
  function handleResponsiveLayout() {
    const isMobile = window.innerWidth <= 768;
    const productContainer = document.querySelector('.currently-market-items');
    
    if (productContainer) {
      if (isMobile) {
        productContainer.style.gridTemplateColumns = '1fr';
        productContainer.style.gap = '15px';
        productContainer.style.padding = '0 10px';
      } else {
        productContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(400px, 1fr))';
        productContainer.style.gap = '30px';
        productContainer.style.padding = '0';
      }
    }
  }
  
  // Listen for window resize
  window.addEventListener('resize', handleResponsiveLayout);
  

  

  

function loadProducts() {
    const container = document.querySelector('.row.currently-market-items');
    if (!container) return;

    // Get products from localStorage
    let products = JSON.parse(localStorage.getItem('products') || '[]');
    
    // Map products to display format
    products = products.map(p => ({
        id: p._id || p.id,
        image: p.image || 'assets/images/market-01.jpg',
        name: p.name,
        Plans: p.plans || p.Plans || '',
        price: p.price || p.pricePerDay || '0',
        total: p.total || p.totalAmount || '0',
        category: p.category || '',
        categoryClass: getCategoryClass(p.category)
    }));

    container.innerHTML = '';

    // Sort products by ID to maintain consistent order
    products.sort((a, b) => a.id - b.id);

    products.forEach(product => {
        const categoryClass = product.categoryClass || '';
        const html = `
            <div class="col-lg-3 col-md-6 col-sm-12 currently-market-item all ${categoryClass}">
                <div class="item">
                    <div class="left-image">
                        <img src="${product.image}" alt="${product.name}">
                    </div>
                    <div class="right-content">
                        <h4>${product.name}</h4>
                        <span class="author"><h2>${product.Plans || ''}</h2></span>
                        <div class="line-dec"></div>
                        <span class="bid">Amount/Day<br><strong>₹${product.price}/day</strong><br><em>(₹${product.total})</em></span>
                        <span class="ends">Ends In<br><strong>100 Days</strong></span>
                        <div class="text-button"><a href="details.html?id=${product.id}">View</a></div>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
}

function getCategoryClass(category) {
    switch(category?.toLowerCase()) {
        case 'room': return 'room';
        case 'apartment': return 'apartment';
        case 'house': return 'house';
        case 'villa': return 'villa';
        default: return '';
    }
}

// Initial load

    loadProducts();

    // Listen for changes
    window.addEventListener('storage', function(e) {
        if (e.key === 'products' || e.key === 'productsUpdated') {
            loadProducts();
        }
    });
    
    // Refresh products every 30 seconds to catch any updates
    setInterval(loadProducts, 30000);

// Add event listener for DOM content loaded to set up filters
document.addEventListener('DOMContentLoaded', function() {
    // Initial load of products
    loadProducts();
    
    // Category filter clicks
    document.querySelectorAll('.filters ul li').forEach(button => {
        button.addEventListener('click', function() {
            const filterValue = this.getAttribute('data-filter');
            const items = document.querySelectorAll('.currently-market-item');
            
            items.forEach(item => {
                if (filterValue === '*' || item.classList.contains(filterValue.substring(1))) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
});
  </script>

  <!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Helper functions can be added here if needed
</script>

  <!-- Add before closing body tag -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

  <!-- Additional Scripts -->
  <script src="assets/js/owl-carousel.js"></script>
  <script src="assets/js/tabs.js"></script>
  <script src="assets/js/popup.js"></script>
  <script src="assets/js/custom.js"></script>
  
  <!-- User Account Info Script -->
  <script>
    // Update user account info when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateUserAccountInfo();
    });
    
    // Function to update user account info
    function updateUserAccountInfo() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      const userAccountInfo = document.getElementById('userAccountInfo');
      
      // Only proceed if element exists
      if (userAccountInfo) {
        if (currentUser) {
          // Show user account info
          userAccountInfo.style.display = 'flex';
          
          // Update profile picture if available
          const userProfilePic = document.getElementById('userProfilePic');
          if (userProfilePic && currentUser.profilePic) {
            userProfilePic.src = currentUser.profilePic;
          }
          
          // Update balance amount
          const userBalanceAmount = document.getElementById('userBalanceAmount');
          if (userBalanceAmount) {
            userBalanceAmount.textContent = '₹' + (currentUser.balance || 0);
          }
          
          // Add click event to redirect to profile page
          userAccountInfo.addEventListener('click', function() {
            window.location.href = 'profile.html';
          });
          
          // Add cursor pointer style
          userAccountInfo.style.cursor = 'pointer';
        } else {
          // Hide user account info if not logged in
          userAccountInfo.style.display = 'none';
        }
      }
    }
  </script>
  
  <script>
    // Toggle withdrawal method details
    document.querySelectorAll('input[name="withdrawalMethod"]').forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'bank') {
          document.getElementById('bankDetails').style.display = 'block';
          document.getElementById('upiDetails').style.display = 'none';
        } else {
          document.getElementById('bankDetails').style.display = 'none';
          document.getElementById('upiDetails').style.display = 'block';
        }
      });
    });
  </script>




  </body>
</html>

<!-- Withdrawal Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="withdrawModalLabel">Withdraw Money</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="withdrawAmount" class="form-label">Enter Amount (₹)</label>
          <input type="number" class="form-control" id="withdrawAmount" min="500" step="100" required>
          <small class="text-muted">Minimum withdrawal amount: ₹500</small>
        </div>

        <div class="mb-3">
          <label for="upiId" class="form-label">Your UPI ID</label>
          <input type="text" class="form-control" id="upiId" placeholder="example@upi" required>
          <small class="text-muted">Enter your registered UPI ID</small>
        </div>

        <div id="withdrawalStatus" class="alert d-none">
          <!-- Status messages will appear here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="initiateWithdrawal()">Withdraw</button>
      </div>
    </div>
  </div>
</div>

<script>
function handleWithdrawal() {
  const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  if (!currentUser) {
    alert('Please login to withdraw money');
    window.location.href = 'login.html';
    return;
  }
  $('#withdrawModal').modal('show');
}

async function initiateWithdrawal() {
  const withdrawAmount = parseFloat(document.getElementById('withdrawAmount').value);
  const upiId = document.getElementById('upiId').value;
  const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  const statusDiv = document.getElementById('withdrawalStatus');

  // Reset status
  statusDiv.className = 'alert';
  
  // Validation checks
  if (!withdrawAmount || withdrawAmount < 500) {
    statusDiv.className = 'alert alert-danger';
    statusDiv.textContent = 'Minimum withdrawal amount is ₹500';
    statusDiv.classList.remove('d-none');
    return;
  }

  if (!upiId || !upiId.includes('@')) {
    statusDiv.className = 'alert alert-danger';
    statusDiv.textContent = 'Please enter a valid UPI ID';
    statusDiv.classList.remove('d-none');
    return;
  }

  if (withdrawAmount > currentUser.balance) {
    statusDiv.className = 'alert alert-danger';
    statusDiv.textContent = 'Insufficient balance';
    statusDiv.classList.remove('d-none');
    return;
  }

  try {
    statusDiv.className = 'alert alert-info';
    statusDiv.textContent = 'Processing withdrawal request...';
    statusDiv.classList.remove('d-none');

    // Call withdrawal API
    const response = await fetch('http://localhost:3000/api/withdraw', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: currentUser.id || currentUser._id,
        amount: withdrawAmount,
        upiId: upiId,
        timestamp: new Date().toISOString()
      })
    });

    if (!response.ok) {
      throw new Error('Withdrawal failed');
    }

    const result = await response.json();

    if (result.success) {
      // Update local balance
      currentUser.balance -= withdrawAmount;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      // Update UI
      const userBalanceAmount = document.getElementById('userBalanceAmount');
      if (userBalanceAmount) {
        userBalanceAmount.textContent = '₹' + currentUser.balance;
      }

      statusDiv.className = 'alert alert-success';
      statusDiv.textContent = 'Withdrawal successful! Amount will be credited to your UPI ID shortly.';

      // Close modal after 3 seconds
      setTimeout(() => {
        $('#withdrawModal').modal('hide');
        // Refresh user stats
        updateUserBalance();
      }, 3000);
    } else {
      throw new Error(result.message || 'Withdrawal failed');
    }
  } catch (error) {
    statusDiv.className = 'alert alert-danger';
    statusDiv.textContent = error.message || 'An error occurred during withdrawal';
  }
}
</script>

   

